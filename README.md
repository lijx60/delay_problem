# delay_problem
discuss delay problem.
  
讨论hal_delay函数问题
hal_delay是单片机stm32初学者，应用很广泛的一个时间延时函数。一般说来，中断函数必须遵循以下二点：在中断里面不能使用这类延时函数；中断函数要快进快出，所用的时间越短越好。但一些条件下，中断若要用延时到怎么办？如少量的延时。很多人就很顺手地把hal_delay用进去，就会造成程序运行问题。
若进程少，程序简单，中断内还是可以少量延时，尤其是在学习模拟阶段。但不能用hal_delay函数做延时，可以采用主程序一直循环计时方式。因为hal_delay函数是采用中断方法延时的！中断里再调用其它中断函数，既形成中断嵌套，而hal_delay函数中断优先级设置最低，无法抢到执行资源；而中断程序又因定时未到而无法出来，相互等对方造成死锁。所以中断程序不适合调用hal_delay。以上理论是说的，实际应用中没有例证。本程序就模拟上述状况，看看中断函数调用hal_delay延时了，会有什么现象？
此程序中用了GPIO中断，当按键压下，既发生沿边中断。此时中断内要处理抖动延时，防止干扰误动，一般延时20~30ms再判断引脚。编译后运行，开始程序正常正常，LED闪烁。当B１按键压下，进入hal_delay延时，真的发生死锁，LED马上停止闪烁，程序无法运行。等了很长时间，程序不会恢复，卡死在那。再换另外一种延时方法，采用cpu主循环计时，既调用delay_ms延时。LED闪烁，虽然浪费cpu资源，但程序会正常执行,不会有死机现象。
实验目的没有那么简单，我们要进一步探讨。试想，既然是在优先级上出了问题，若采用优先级反转方式，是不是就可以调用hal_delay函数？于是事先把GPIO中断优先级设置低点，再将hal_delay函数优先级设置高点（如令TickPriority = 0）。中断嵌套就不会抢占hal_delay资源现象，看看程序运行会出现什么状况？
实验结果奇迹出现了：中断函数可以调用hal_delay做延时，不会发生进程死锁现象。LED能正常闪烁。
当然，这只是检验一下优先级问题，加深对hal_delay函数理解。在中断函数内，还是不能调用延时函数的，要快进快出！ 
#define  TICK_INT_PRIORITY            ((uint32_t)15) 
